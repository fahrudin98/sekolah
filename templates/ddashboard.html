<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - {{ username }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            background-color: #f8f9fa; 
        }
        .container { 
            margin-top: 50px; 
        }
        .logout-btn { 
            margin-bottom: 0px; 
        }
        .tab-content { 
            background: #fff; 
            padding: 10px 15px; 
            border-radius: 8px; 
            box-shadow: 0 0 10px rgba(0,0,0,0.1); 
        }
        .flash-message { 
            margin-bottom: 10px; 
        }
        
        /* Perbaikan khusus untuk tab siswa */
        #siswa {
            padding-top: 0 !important;
        }
        #siswa .alert {
            margin-bottom: 10px;
            padding: 10px;
        }
        #siswa h4 {
            margin-bottom: 15px;
        }
        #siswa .form-label {
            margin-bottom: 5px;
        }
        #siswa .mb-3 {
            margin-bottom: 15px !important;
        }
        .nav-tabs {
            margin-bottom: 0;
        }
        .tab-content.mt-1 {
            margin-top: 0 !important;
            padding-top: 15px;
        }
    
        /* Hilangkan panah spinner pada input number */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        
    </style>
</head>
<body>

    <div class="container">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>Selamat datang, {{ username }}!</h2>
            <div class="d-flex align-items-center gap-2">
                <button class="btn btn-warning btn-sm" style="height: 38px;" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                    Change Password
                </button>
                <a href="{{ url_for('logout') }}" class="btn btn-danger logout-btn align-self-center" style="height: 38px;">Logout</a>
            </div>
        </div>
      
        <!-- Navbar -->
        <nav class="navbar navbar-expand-lg navbar-light bg-light mb-3 rounded shadow-sm">
          <div class="container-fluid">
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
              aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
              <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
              <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                  <a class="nav-link" href="{{ url_for('pegawai_bp.update_pegawai', pegawai_id=current_user.pegawai.id) }}">Update Profile</a>
                </li>
                <!-- Dropdown Laporan -->
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="laporanDropdown" role="button" 
                    data-bs-toggle="dropdown" aria-expanded="false">
                    Laporan
                    </a>
                    <ul class="dropdown-menu" aria-labelledby="laporanDropdown">
                    <li>
                        <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#laporanBulananModal">
                        Laporan Bulanan
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#laporanSemesterModal">
                        Laporan Semester
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#laporanTahunanModal">
                        Laporan Tahunan
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#laporanPenilaianSiswaModal">
                        Laporan Perkembangan Siswa
                        </a>
                    </li>
                    </ul>
                </li>
    
                {% if current_user.is_superadmin %}
                <li class="nav-item">
                  <a class="nav-link" href="{{ url_for('tahun_ajaran.dashboard') }}">Settings</a>
                </li>
                {% endif %}
              </ul>
            </div>
          </div>
        </nav>
    
        <!-- Dashboard Tabs -->
        <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tahun-tab" data-bs-toggle="tab" data-bs-target="#tahun" type="button" role="tab">Sekolah Tahun Ajaran</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="kelas-tab" data-bs-toggle="tab" data-bs-target="#kelas" type="button" role="tab">Kelas Tahun Ajaran</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="siswa-tab" data-bs-toggle="tab" data-bs-target="#siswa" type="button" role="tab">Data Siswa</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="penilaian-tab" data-bs-toggle="tab" data-bs-target="#Penilaian" type="button" role="tab">Penilaian</button>
            </li>
        </ul>
    
        <!-- Tab Content -->
        <div class="tab-content mt-1" id="dashboardTabsContent">
            <!-- TAB TAHUN AJARAN -->
            <div class="tab-pane fade" id="tahun" role="tabpanel">
                <h4 class="mb-2">Tahun Ajaran</h4>
    
                <!-- Info Sekolah & Tahun Ajaran -->
                <div class="alert alert-info mb-2">
                    <div class="row mb-1">
                        <div class="col-md-6">
                            <strong>Sekolah:</strong> {{ sekolah.nama_sekolah if sekolah and sekolah.nama_sekolah else '-' }} <br>
                            <strong>Kecamatan:</strong> {{ sekolah.kecamatan.nama if sekolah and sekolah.kecamatan else '-' }} <br>
                            <strong>Kabupaten:</strong> {{ sekolah.kecamatan.kabupaten.nama if sekolah and sekolah.kecamatan and sekolah.kecamatan.kabupaten else '-' }} <br>
                            <strong>Provinsi:</strong> {{ sekolah.kecamatan.kabupaten.provinsi.nama if sekolah and sekolah.kecamatan and sekolah.kecamatan.kabupaten and sekolah.kecamatan.kabupaten.provinsi else '-' }}
                        </div>
    
                        <div class="col-md-6">
                            <strong>Tahun Ajaran:</strong> {{ active_tahun_ajaran.tahun_ajaran if active_tahun_ajaran else '-' }} <br>
                            <strong>Semester:</strong> {{ active_tahun_ajaran.semester|capitalize if active_tahun_ajaran else '-' }} <br>
                            <strong>Kepala Sekolah:</strong>
                            {% if active_tahun_ajaran and active_tahun_ajaran.kepala_sekolah %}
                                {{ active_tahun_ajaran.kepala_sekolah.nama }}
                            {% else %}
                                -
                            {% endif %} <br>
                            <strong>NIP:</strong>
                            {% if active_tahun_ajaran and active_tahun_ajaran.kepala_sekolah %}
                                {{ active_tahun_ajaran.kepala_sekolah.nip }}
                            {% else %}
                                -
                            {% endif %}
                        </div>
                    </div>
                </div>
    
                <!-- Form Tahun Ajaran -->
                {% if not active_tahun_ajaran or not active_tahun_ajaran.aktif %}
                <form id="formTahunAjaran" class="mb-3">
                    <div class="mb-2">
                        <label class="form-label">Tahun Ajaran</label>
                        <input type="text" class="form-control" name="tahun_ajaran" placeholder="2025/2026" required>
                    </div>
    
                    <div class="mb-2">
                        <label class="form-label">Semester</label>
                        <select class="form-control" name="semester" required>
                            <option value="">-- Pilih Semester --</option>
                            <option value="ganjil">Ganjil</option>
                            <option value="genap">Genap</option>
                        </select>
                    </div>
    
                    <div class="mb-2">
                        <label class="form-label">Kepala Sekolah</label>
                        {% if pegawai_dengan_profil and pegawai_dengan_profil|length > 0 %}
                            <select class="form-select" id="kepalaSelect" name="kepala_sekolah_id" required>
                                {% for p in pegawai_dengan_profil %}
                                <option value="{{ p.id }}" data-nip="{{ p.nip }}"
                                    {% if current_user.pegawai and p.id == current_user.pegawai.id %}selected{% endif %}>
                                    {{ p.nama }} (NIP: {{ p.nip }})
                                </option>
                                {% endfor %}
                            </select>
                        {% else %}
                            <div class="alert alert-warning">
                                Belum ada pegawai yang mengisi profil. Silakan minta pegawai mengisi profil terlebih dahulu.
                            </div>
                        {% endif %}
                    </div>
    
                    <div class="mb-2">
                        <label class="form-label">NIP</label>
                        <input type="text" class="form-control" id="kepalaNip" readonly>
                    </div>
    
                    <button type="submit" class="btn btn-primary"
                        {% if not pegawai_dengan_profil or pegawai_dengan_profil|length==0 %} disabled {% endif %}>
                        Tambah Tahun Ajaran
                    </button>
                </form>
                {% endif %}
    
                <!-- Status Tahun Ajaran -->
                {% if active_tahun_ajaran %}
                <div class="mt-3">
                    <p>
                        {% if active_tahun_ajaran.aktif %}
                            <span class="badge bg-success fs-5 px-3 py-2">Status Aktif</span>
                        {% else %}
                            <span class="badge bg-secondary fs-6 px-2 py-1 opacity-70">Nonaktif</span>
                        {% endif %}
                    </p>
    
                    <form id="formToggleAktif">
                        <input type="hidden" name="id" value="{{ active_tahun_ajaran.id }}">
                        <button type="submit" class="btn btn-warning">
                            {% if active_tahun_ajaran.aktif %} Nonaktifkan {% else %} Aktifkan {% endif %}
                        </button>
                    </form>
                </div>
                {% endif %}
    
                <!-- Tabel Tahun Ajaran Nonaktif -->
                {% if nonaktif_tahun_ajaran and nonaktif_tahun_ajaran|length > 0 %}
                    <h5 class="mt-4">Tahun Ajaran Nonaktif</h5>
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Tahun Ajaran</th>
                                <th>Semester</th>
                                <th>Kepala Sekolah</th>
                                <th>NIP</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for t in nonaktif_tahun_ajaran %}
                            <tr>
                                <td>{{ t.tahun_ajaran }}</td>
                                <td>{{ t.semester|capitalize }}</td>
                                <td>{{ t.kepala_sekolah.nama }}</td>
                                <td>{{ t.kepala_sekolah.nip }}</td>
                                <td>
                                    <form class="formToggleAktif d-inline" method="post" action="/tahun_ajaran/toggle_tahun_ajaran">
                                        <input type="hidden" name="id" value="{{ t.id }}">
                                        <button type="submit" class="btn btn-sm btn-success">
                                            Aktifkan
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p class="text-muted">Belum ada tahun ajaran nonaktif</p>
                {% endif %}
            </div>
    
            <!-- TAB KELAS -->
            <div class="tab-pane fade" id="kelas" role="tabpanel">
                <h4>Kelas Tahun Ajaran</h4>
    
                {% if active_tahun_ajaran %}
                    <div class="alert alert-info">
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Sekolah:</strong> {{ sekolah.nama_sekolah }} <br>
                                <strong>Kecamatan:</strong> {{ sekolah.kecamatan.nama if sekolah.kecamatan else '-' }} <br>
                                <strong>Kabupaten:</strong> {{ sekolah.kecamatan.kabupaten.nama if sekolah.kecamatan and sekolah.kecamatan.kabupaten else '-' }} <br>
                                <strong>Provinsi:</strong> {{ sekolah.kecamatan.kabupaten.provinsi.nama if sekolah.kecamatan and sekolah.kecamatan.kabupaten and sekolah.kecamatan.kabupaten.provinsi else '-' }}
                            </div>
    
                            <div class="col-md-6">
                                <strong>Tahun Ajaran:</strong> {{ active_tahun_ajaran.tahun_ajaran }} <br>
                                <strong>Semester:</strong> {{ active_tahun_ajaran.semester|capitalize }} <br>
                                <strong>Wali Kelas:</strong> {{ current_user.pegawai.nama }} <br>
                                <strong>NIP:</strong> {{ current_user.pegawai.nip }}
                            </div>
                        </div>
                    </div>
    
                    <!-- Form Tambah Kelas -->
                    <form id="formKelas" class="mb-3">
                        <div class="mb-2">
                            <label class="form-label">Nama Kelas</label>
                            <input type="text" class="form-control" name="nama_kelas" placeholder="Misal: X IPA 1" required>
                        </div>
    
                        <input type="hidden" name="wali_kelas_id" value="{{ current_user.pegawai.id }}">
    
                        <button type="submit" class="btn btn-primary">Tambah Kelas</button>
                    </form>
                {% else %}
                    <div class="alert alert-warning">
                        Belum ada tahun ajaran aktif. Silakan atur tahun ajaran terlebih dahulu.
                    </div>
                {% endif %}
    
                <!-- DAFTAR KELAS -->
                <h5>Daftar Kelas</h5>
                <table class="table table-striped" id="kelasTable">
                    <thead>
                        <tr>
                            <th>Nama Kelas</th>
                            <th>Wali Kelas</th>
                            <th>NIP</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for k in kelas_list %}
                        <tr data-id="{{ k.id }}">
                            <td class="nama-kelas">{{ k.nama_kelas }}</td>
                            <td>{{ k.wali_kelas.nama }}</td>
                            <td>{{ k.wali_kelas.nip }}</td>
                            <td>
                                {% if k.wali_kelas_id == current_user.pegawai.id %}
                                    <button class="btn btn-sm btn-warning edit-btn" data-id="{{ k.id }}">Edit</button>
                                    <button class="btn btn-sm btn-danger delete-btn" data-id="{{ k.id }}">Hapus</button>
                                {% else %}
                                    <span class="text-muted">Tidak ada akses</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr><td colspan="4" class="text-center">Belum ada kelas</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
    
            <!-- TAB SISWA -->
            <div class="tab-pane fade" id="siswa" role="tabpanel">
                <h4 class="mb-3">Data Siswa</h4>
    
                <div class="mb-3">
                    <div class="row mb-2">
                        <div class="col-md-6">
                            <div class="alert alert-info mb-2 p-2">
                                <strong>Sekolah:</strong> {{ sekolah.nama_sekolah }} <br>
                                <strong>Kecamatan:</strong> {{ sekolah.kecamatan.nama if sekolah.kecamatan else '-' }} <br>
                                <strong>Kabupaten:</strong> {{ sekolah.kecamatan.kabupaten.nama if sekolah.kecamatan and sekolah.kecamatan.kabupaten else '-' }} <br>
                                <strong>Provinsi:</strong> {{ sekolah.kecamatan.kabupaten.provinsi.nama if sekolah.kecamatan and sekolah.kecamatan.kabupaten and sekolah.kecamatan.kabupaten.provinsi else '-' }}
                            </div>
                        </div>
    
                        <div class="col-md-6">
                            <div class="alert alert-secondary mb-2 p-2">
                                <strong>Wali Kelas:</strong> {{ current_user.pegawai.nama if current_user.pegawai else '-' }} <br>
                                <strong>NIP:</strong> {{ current_user.pegawai.nip if current_user.pegawai else '-' }}
                            </div>
    
                            <div class="mb-2">
                                <label class="form-label">Pilih Kelas</label>
                                <select id="kelasDropdown" class="form-select">
                                    <option value="">-- Pilih Kelas --</option>
                                    {% for k in kelas_list if k.wali_kelas_id == current_user.pegawai.id %}
                                        <option value="{{ k.id }}">{{ k.nama_kelas }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
    
                    <!-- Form Tambah Siswa -->
                    <form id="formSiswa" class="mt-2 d-none">
                        <input type="hidden" name="kelas_id" id="kelasIdInput">
                        <h5 class="mb-2">Tambah Siswa</h5>
                        
                        <!-- Pencarian Siswa yang Sudah Ada -->
                        <div class="card mb-3">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0">üîç Cari Siswa yang Sudah Ada</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-8">
                                        <input type="text" class="form-control" id="searchSiswa" 
                                            placeholder="Cari berdasarkan nama atau NISN...">
                                    </div>
                                    <div class="col-md-4">
                                        <button type="button" class="btn btn-outline-primary w-100" onclick="searchExistingSiswa()">
                                            Cari Siswa
                                        </button>
                                    </div>
                                </div>
                                <div id="searchResults" class="mt-2" style="max-height: 200px; overflow-y: auto;"></div>
                            </div>
                        </div>
    
                        <!-- Tambah Siswa Baru Manual -->
                        <div class="card">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0">‚ûï Tambah Siswa Baru</h6>
                            </div>
                            <div class="card-body">
                                <table class="table table-bordered align-middle" id="tambahSiswaTable">
                                    <thead>
                                        <tr>
                                            <th>Nama Siswa</th>
                                            <th>NISN</th>
                                            <th>Jenis Kelamin</th>
                                            <th>Status</th>
                                            <th>Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="siswaFormBody">
                                        <tr>
                                            <td><input type="text" name="nama_siswa[]" class="form-control" required></td>
                                            <td><input type="text" name="nisn[]" class="form-control" placeholder="Opsional"></td>
                                            <td>
                                                <select name="jenis_kelamin[]" class="form-select" required>
                                                    <option value="">-- Pilih --</option>
                                                    <option value="L">Laki-laki</option>
                                                    <option value="P">Perempuan</option>
                                                </select>
                                            </td>
                                            <td>
                                                <select name="status[]" class="form-select">
                                                    <option value="Aktif">Aktif</option>
                                                    <option value="Tidak Aktif">Tidak Aktif</option>
                                                    <option value="Pindah">Pindah</option>
                                                </select>
                                            </td>
                                            <td><button type="button" class="btn btn-danger btn-sm remove-row">Hapus</button></td>
                                        </tr>
                                    </tbody>
                                </table>
    
                                <div class="d-flex gap-2 mb-2">
                                    <button type="button" id="addRow" class="btn btn-success btn-sm">+ Tambah Baris</button>
                                    <button type="submit" class="btn btn-primary">Simpan Semua Siswa Baru</button>
                                </div>
                            </div>
                        </div>
                    </form>
    
                    <!-- Tabel Daftar Siswa -->
                    <h5 class="mt-3">Daftar Siswa</h5>
                    <table class="table table-striped" id="siswaTable">
                        <thead>
                            <tr>
                                <th>Nama</th>
                                <th>NISN</th>
                                <th>Jenis Kelamin</th>
                                <th>Status</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="5" class="text-center">Pilih kelas terlebih dahulu</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
    
            <!-- TAB PENILAIAN -->
            <div class="tab-pane fade" id="Penilaian" role="tabpanel">
                <h4>Penilaian Kebiasaan Siswa</h4>
    
                {% if active_tahun_ajaran %}
                <div class="alert alert-info">
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Sekolah:</strong> {{ sekolah.nama_sekolah }} <br>
                            <strong>Kecamatan:</strong> {{ sekolah.kecamatan.nama if sekolah.kecamatan else '-' }} <br>
                            <strong>Kabupaten:</strong> {{ sekolah.kecamatan.kabupaten.nama if sekolah.kecamatan and sekolah.kecamatan.kabupaten else '-' }} <br>
                            <strong>Provinsi:</strong> {{ sekolah.kecamatan.kabupaten.provinsi.nama if sekolah.kecamatan and sekolah.kecamatan.kabupaten and sekolah.kecamatan.kabupaten.provinsi else '-' }}
                        </div>
                        <div class="col-md-6">
                            <strong>Tahun Ajaran:</strong> {{ active_tahun_ajaran.tahun_ajaran }} <br>
                            <strong>Semester:</strong> {{ active_tahun_ajaran.semester|capitalize }} <br>
                            <strong>Wali Kelas:</strong> {{ current_user.pegawai.nama }} <br>
                            <strong>NIP:</strong> {{ current_user.pegawai.nip }} <br>
    
                            <label for="kelasSelectPenilaian" class="form-label">Kelas</label>
                            <select class="form-select" id="kelasSelectPenilaian" data-tahun="{{ active_tahun_ajaran.id if active_tahun_ajaran else '' }}">
                                <option value="">-- Pilih Kelas --</option>
                                {% for k in kelas_list if k.wali_kelas_id == current_user.pegawai.id %}
                                    <option value="{{ k.id }}">{{ k.nama_kelas }}</option>
                                {% endfor %}
                            </select>
                            
                            <label for="bulanSelectPenilaian" class="form-label mt-2">Pilih Bulan</label>
                            <select class="form-select" id="bulanSelectPenilaian" name="bulan">
                                <option value="">-- Pilih Bulan --</option>
                                {% for b in bulan_list %}
                                    <option value="{{ b.value }}">{{ b.label }}</option>
                                {% endfor %}
                            </select>
                            <button type="button" class="btn btn-success mt-2" id="btnGenerateReport" 
                            onclick="generateReport()">
                               üìÑ Generate Report
                            </button>
                        </div>
                    </div>
                </div>
    
                <table class="table table-bordered table-striped">
                    <thead>
                        <tr>
                            <th rowspan="2" class="align-middle text-center">No</th>
                            <th rowspan="2" class="align-middle text-center">Nama Siswa</th>
                            <th colspan="7" class="text-center">Nilai Kebiasaan</th>
                            <th rowspan="2" class="align-middle text-center">Catatan</th>
                            <th rowspan="2" class="align-middle text-center">Aksi</th>
                        </tr>
                        <tr>
                            <th>Bangun Pagi</th>
                            <th>Beribadah</th>
                            <th>Berolahraga</th>
                            <th>Makan Sehat &amp; Bergizi</th>
                            <th>Belajar</th>
                            <th>Bermasyarakat</th>
                            <th>Tidur Cepat</th>
                        </tr>
                    </thead>
                    <tbody id="siswaTableBody">
                        <tr><td colspan="11" class="text-center">Silakan pilih kelas terlebih dahulu</td></tr>
                    </tbody>
                </table>
    
                {% else %}
                <div class="alert alert-warning">
                    Tidak ada tahun ajaran aktif. Silakan buat / aktifkan tahun ajaran dulu.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- MODAL EDIT SISWA -->
    <div class="modal fade" id="editSiswaModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <form id="editSiswaForm" class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Siswa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="id" id="editId">
                    <div class="mb-2">
                        <label class="form-label">Nama Siswa</label>
                        <input type="text" class="form-control" name="nama_siswa" id="editNama" required>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">NISN</label>
                        <input type="text" class="form-control" name="nisn" id="editNisn" placeholder="Opsional">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Jenis Kelamin</label>
                        <select class="form-select" name="jenis_kelamin" id="editJK" required>
                            <option value="">-- Pilih --</option>
                            <option value="L">Laki-laki</option>
                            <option value="P">Perempuan</option>
                        </select>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Status</label>
                        <input type="text" class="form-control" name="status" id="editStatus">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Simpan Perubahan</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- MODAL CHANGE PASSWORD -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="changePasswordForm">
                    <div class="modal-header">
                        <h5 class="modal-title" id="changePasswordModalLabel">Ganti Password</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="currentPassword" class="form-label">Password Saat Ini</label>
                            <input type="password" class="form-control" id="currentPassword" name="current_password" required>
                        </div>
                        <div class="mb-3">
                            <label for="newPassword" class="form-label">Password Baru</label>
                            <input type="password" class="form-control" id="newPassword" name="new_password" required>
                        </div>
                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label">Konfirmasi Password Baru</label>
                            <input type="password" class="form-control" id="confirmPassword" name="confirm_password" required>
                        </div>
                        <div id="changePasswordMessage" class="text-danger"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                        <button type="submit" class="btn btn-primary">Simpan Password</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- MODAL LAPORAN BULANAN -->
    <div class="modal fade" id="laporanBulananModal" tabindex="-1" aria-labelledby="laporanBulananModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="laporanForm" method="get" target="_blank">
                    <div class="modal-header">
                        <h5 class="modal-title" id="laporanBulananModalLabel">Pilih Laporan Bulanan</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <label for="kelasSelect" class="form-label">Kelas</label>
                        <select class="form-select" id="kelasSelect" name="kelas_id" required>
                            <option value="">-- Pilih Kelas --</option>
                            {% for k in kelas_list if k.wali_kelas_id == current_user.pegawai.id %}
                                <option value="{{ k.id }}">{{ k.nama_kelas }}</option>
                            {% endfor %}
                        </select>
    
                        <label for="bulanSelect" class="form-label mt-3">Bulan</label>
                        <select class="form-select" id="bulanSelect" name="bulan" required>
                            <option value="">-- Pilih Bulan --</option>
                            {% for b in bulan_list %}
                                <option value="{{ b.value }}">{{ b.label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">Lihat Laporan</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- MODAL LAPORAN SEMESTER -->
    <div class="modal fade" id="laporanSemesterModal" tabindex="-1" aria-labelledby="laporanSemesterModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="laporanSemesterForm" method="get" target="_blank">
                    <div class="modal-header">
                        <h5 class="modal-title" id="laporanSemesterModalLabel">Pilih Laporan Semester</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <label for="kelasSemesterSelect" class="form-label">Kelas</label>
                        <select class="form-select" id="kelasSemesterSelect" name="kelas_id" required>
                            <option value="">-- Pilih Kelas --</option>
                            {% for k in kelas_list if k.wali_kelas_id == current_user.pegawai.id %}
                                <option value="{{ k.id }}">{{ k.nama_kelas }}</option>
                            {% endfor %}
                        </select>
    
                        <label for="semesterSelect" class="form-label mt-3">Semester</label>
                        <select class="form-select" id="semesterSelect" name="semester" required>
                            <option value="">-- Pilih Semester --</option>
                            <option value="ganjil">Ganjil</option>
                            <option value="genap">Genap</option>
                        </select>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-success">Lihat Laporan</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- MODAL LAPORAN TAHUNAN -->
    <div class="modal fade" id="laporanTahunanModal" tabindex="-1" aria-labelledby="laporanTahunanModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="laporanTahunanForm" method="get" target="_blank">
                    <div class="modal-header">
                        <h5 class="modal-title" id="laporanTahunanModalLabel">Pilih Laporan Tahunan</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <label for="kelasTahunanSelect" class="form-label">Kelas</label>
                        <select class="form-select" id="kelasTahunanSelect" name="kelas_id" required>
                            <option value="">-- Pilih Kelas --</option>
                            {% for k in kelas_list if k.wali_kelas_id == current_user.pegawai.id %}
                                <option value="{{ k.id }}">{{ k.nama_kelas }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                        <button type="submit" class="btn btn-success">Lihat Laporan</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- MODAL LAPORAN PENILAIAN SISWA -->
    <div class="modal fade" id="laporanPenilaianSiswaModal" tabindex="-1" aria-labelledby="laporanPenilaianSiswaModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="laporanPenilaianSiswaForm" method="get" target="_blank">
                    <div class="modal-header">
                        <h5 class="modal-title" id="laporanPenilaianSiswaModalLabel">Laporan Penilaian Per Siswa</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Tahun Ajaran -->
                        <label for="tahunAjaranSelect" class="form-label">Tahun Ajaran</label>
                        <select class="form-select" id="tahunAjaranSelect" name="tahun_ajaran_id" required>
                            <option value="">-- Pilih Tahun Ajaran --</option>
                        </select>

                        <!-- Semester -->
                        <label for="semesterSelect" class="form-label mt-3">Semester</label>
                        <select class="form-select" id="semesterSelect" name="semester" required>
                            <option value="">-- Pilih Semester --</option>
                            <option value="ganjil">Semester Ganjil</option>
                            <option value="genap">Semester Genap</option>
                        </select>

                        <!-- Kelas -->
                        <label for="kelasPenilaianSelect" class="form-label mt-3">Kelas</label>
                        <select class="form-select" id="kelasPenilaianSelect" name="kelas_id" required disabled>
                            <option value="">-- Pilih Kelas --</option>
                        </select>

                        <!-- Siswa -->
                        <label for="siswaPenilaianSelect" class="form-label mt-3">Siswa</label>
                        <select class="form-select" id="siswaPenilaianSelect" name="siswa_id" required disabled>
                            <option value="">-- Pilih Siswa --</option>
                        </select>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                        <button type="submit" class="btn btn-success" id="submitLaporanBtn" disabled>Lihat Laporan</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        console.log("Dashboard loaded successfully");
        
        // ========== TAHUN AJARAN ==========
        
        // Form Tambah Tahun Ajaran
        document.getElementById("formTahunAjaran")?.addEventListener("submit", handleTahunAjaranSubmit);
        
        // Form Toggle Aktif Tahun Ajaran
        document.getElementById("formToggleAktif")?.addEventListener("submit", handleToggleTahunAjaran);
        
        // Delegasi event untuk semua form toggle aktif
        document.addEventListener("submit", function(e) {
            if (e.target.classList.contains("formToggleAktif")) {
                e.preventDefault();
                handleToggleTahunAjaran(e);
            }
        });
    
        // Kepala Sekolah Select
        const kepalaSelect = document.getElementById("kepalaSelect");
        if (kepalaSelect) {
            kepalaSelect.addEventListener("change", function() {
                const selected = this.options[this.selectedIndex];
                document.getElementById("kepalaNip").value = selected.getAttribute("data-nip") || "";
            });
            kepalaSelect.dispatchEvent(new Event("change"));
        }
    
        // ========== KELAS ==========
        
        const formKelas = document.getElementById("formKelas");
        const kelasTableBody = document.querySelector("#kelasTable tbody");
        
        if (formKelas) {
            formKelas.addEventListener("submit", handleKelasSubmit);
        }
        
        if (kelasTableBody) {
            kelasTableBody.addEventListener("click", handleKelasActions);
        }
    
        // ========== SISWA ==========
        
        const kelasDropdown = document.getElementById("kelasDropdown");
        const formSiswa = document.getElementById("formSiswa");
        const siswaTableBody = document.querySelector("#siswaTable tbody");
        
        if (kelasDropdown) {
            kelasDropdown.addEventListener("change", handleKelasChange);
        }
        
        if (formSiswa) {
            formSiswa.addEventListener("submit", handleSiswaSubmit);
        }
        
        // Tambah baris input siswa
        document.getElementById("addRow")?.addEventListener("click", addSiswaInputRow);
        
        // Hapus baris input siswa
        document.addEventListener("click", function(e) {
            if (e.target.classList.contains("remove-row")) {
                e.target.closest("tr").remove();
            }
        });
        
        // Form edit siswa
        document.getElementById("editSiswaForm")?.addEventListener("submit", handleEditSiswa);
    
        // ========== PENILAIAN KEBIASAAN ==========
        
        const kelasSelectPenilaian = document.getElementById("kelasSelectPenilaian");
        const bulanSelectPenilaian = document.getElementById("bulanSelectPenilaian");
        const siswaTableBodyPenilaian = document.getElementById("siswaTableBody");
        
        
        if (kelasSelectPenilaian && bulanSelectPenilaian) {
            initializePenilaianKebiasaan();
        }


        // ========== CHANGE PASSWORD ==========
        
        document.getElementById("changePasswordForm")?.addEventListener("submit", handleChangePassword);
    
        // ========== LAPORAN ==========
        
        initializeLaporanModals();
    
        // ========== FUNGSI HANDLER ==========
    
        // Handler Tahun Ajaran
        async function handleTahunAjaranSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            try {
                const response = await fetch("{{ url_for('tahun_ajaran.add_tahun_ajaran') }}", {
                    method: "POST",
                    body: formData
                });
                const result = await response.json();
                
                if(result.success){
                    alert("Tahun ajaran berhasil ditambahkan");
                    location.reload();
                } else {
                    alert(result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert("Terjadi kesalahan saat menambah tahun ajaran");
            }
        }
    
        async function handleToggleTahunAjaran(e) {
            e.preventDefault();
            const form = e.target;
            const action = form.action || "{{ url_for('tahun_ajaran.toggle_tahun_ajaran') }}";
            
            try {
                const response = await fetch(action, {
                    method: "POST",
                    body: new FormData(form)
                });
    
                const result = await response.json();
                if(result.success){
                    alert("Status tahun ajaran diperbarui");
                    location.reload();
                } else {
                    alert(result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert("Terjadi kesalahan saat mengubah status tahun ajaran");
            }
        }
    
        // Handler Kelas
        async function handleKelasSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
    
            try {
                const response = await fetch("{{ url_for('kelas.create_kelas') }}", {
                    method: "POST",
                    body: formData
                });
                const result = await response.json();
    
                if(result.success){
                    alert(result.message);
                    updateKelasTable(result.kelas);
                    e.target.reset();
                } else {
                    alert(result.message);
                }
            } catch (err) {
                console.error(err);
                alert("Terjadi kesalahan saat menyimpan kelas.");
            }
        }
    
        async function handleKelasActions(e) {
            const target = e.target;
            const row = target.closest("tr");
            const id = row?.dataset.id;
    
            if (!id) return;
    
            if(target.classList.contains("delete-btn")){
                if (!confirm("Hapus kelas ini?")) return;
                await deleteKelas(id, row);
            }
    
            if(target.classList.contains("edit-btn")){
                await editKelas(id, row);
            }
        }
    
        async function deleteKelas(id, row) {
            try {
                const resp = await fetch(`/kelas/delete/${id}`, { method: "POST" });
                const result = await resp.json();
                if(result.success){
                    row.remove();
                } else {
                    alert(result.message);
                }
            } catch (err) {
                console.error(err);
                alert("Gagal menghapus kelas.");
            }
        }
    
        async function editKelas(id, row) {
            const currentNama = row.querySelector(".nama-kelas").innerText;
            const newNama = prompt("Ubah Nama Kelas:", currentNama);
            if(!newNama || newNama === currentNama) return;
    
            try {
                const resp = await fetch(`/kelas/edit/${id}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ nama_kelas: newNama })
                });
                const result = await resp.json();
                if(result.success){
                    row.querySelector(".nama-kelas").innerText = newNama;
                } else {
                    alert(result.message);
                }
            } catch (err) {
                console.error(err);
                alert("Gagal mengedit kelas.");
            }
        }
    
        function updateKelasTable(kelas) {
            const kosongRow = kelasTableBody.querySelector("tr td[colspan]");
            if (kosongRow) kosongRow.parentElement.remove();
    
            const row = document.createElement("tr");
            row.setAttribute("data-id", kelas.id);
            row.innerHTML = `
                <td class="nama-kelas">${kelas.nama_kelas}</td>
                <td>${kelas.wali_kelas.nama}</td>
                <td>${kelas.wali_kelas.nip}</td>
                <td>
                    <button class="btn btn-sm btn-warning edit-btn" data-id="${kelas.id}">Edit</button>
                    <button class="btn btn-sm btn-danger delete-btn" data-id="${kelas.id}">Hapus</button>
                </td>
            `;
            kelasTableBody.appendChild(row);
        }
    
        // Handler Siswa
        async function handleKelasChange() {
            const kelasId = this.value;
            const kelasIdInput = document.getElementById("kelasIdInput");
            
            if (!kelasId) {
                formSiswa?.classList.add("d-none");
                if (siswaTableBody) {
                    siswaTableBody.innerHTML = `<tr><td colspan="5" class="text-center">Pilih kelas terlebih dahulu</td></tr>`;
                }
                return;
            }
    
            formSiswa?.classList.remove("d-none");
            if (kelasIdInput) kelasIdInput.value = kelasId;
            await loadSiswa(kelasId);
        }
    
        async function loadSiswa(kelasId) {
            try {
                const resp = await fetch(`/siswa/list/${kelasId}`);
                const data = await resp.json();
                if (data.success) {
                    renderSiswaTable(data.siswa);
                } else {
                    alert(data.message);
                }
            } catch (error) {
                console.error('Error loading siswa:', error);
                alert('Gagal memuat data siswa');
            }
        }
    
        function renderSiswaTable(siswaList) {
            if (!siswaTableBody) return;
            
            siswaTableBody.innerHTML = "";
            if (siswaList.length === 0) {
                siswaTableBody.innerHTML = `<tr><td colspan="5" class="text-center">Belum ada siswa</td></tr>`;
                return;
            }
            siswaList.forEach(s => addSiswaRow(s));
        }
    
        function addSiswaRow(s) {
            const row = document.createElement("tr");
            row.setAttribute("data-id", s.id);
            row.innerHTML = `
                <td>${s.nama_siswa}</td>
                <td>${s.nisn || '-'}</td>
                <td>${s.jenis_kelamin === "L" ? "Laki-laki" : "Perempuan"}</td>
                <td>${s.status}</td>
                <td>
                    <button class="btn btn-sm btn-warning edit-btn" data-id="${s.id}">Edit</button>
                    <button class="btn btn-sm btn-danger delete-btn" data-id="${s.id}">Hapus</button>
                </td>
            `;
            siswaTableBody.appendChild(row);
    
            row.querySelector(".edit-btn").addEventListener("click", function() {
                openEditModal(s);
            });
    
            row.querySelector(".delete-btn").addEventListener("click", async function() {
                if (!confirm("Hapus siswa ini?")) return;
                const resp = await fetch(`/siswa/delete/${s.id}`, { method: "POST" });
                const del = await resp.json();
                if (del.success) row.remove();
                else alert(del.message);
            });
        }
    
        async function handleSiswaSubmit(e) {
            e.preventDefault();
            const rows = document.querySelectorAll("#siswaFormBody tr");
            const kelasId = kelasDropdown.value;
            let successCount = 0;
    
            for (let row of rows) {
                const nama = row.querySelector('input[name="nama_siswa[]"]').value;
                const nisn = row.querySelector('input[name="nisn[]"]').value;
                const jk = row.querySelector('select[name="jenis_kelamin[]"]').value;
                const status = row.querySelector('select[name="status[]"]').value;
    
                if (!nama || !jk) continue;
    
                const formData = new FormData();
                formData.append("kelas_id", kelasId);
                formData.append("nama_siswa", nama);
                formData.append("nisn", nisn);
                formData.append("jenis_kelamin", jk);
                formData.append("status", status);
    
                try {
                    const resp = await fetch(`/siswa/create`, {
                        method: "POST",
                        body: formData
                    });
                    const result = await resp.json();
                    if (result.success) {
                        successCount++;
                    } else {
                        alert("Gagal tambah siswa: " + result.message);
                    }
                } catch (error) {
                    console.error('Error adding siswa:', error);
                    alert("Terjadi kesalahan saat menambah siswa");
                }
            }
    
            if (successCount > 0) {
                alert(successCount + " siswa berhasil ditambahkan.");
                await loadSiswa(kelasId);
                resetSiswaForm();
            }
        }
    
        function addSiswaInputRow() {
            let tbody = document.getElementById("siswaFormBody");
            let row = document.createElement("tr");
            row.innerHTML = `
                <td><input type="text" name="nama_siswa[]" class="form-control" required></td>
                <td><input type="text" name="nisn[]" class="form-control" placeholder="Opsional"></td>
                <td>
                    <select name="jenis_kelamin[]" class="form-select" required>
                        <option value="">-- Pilih --</option>
                        <option value="L">Laki-laki</option>
                        <option value="P">Perempuan</option>
                    </select>
                </td>
                <td>
                    <select name="status[]" class="form-select">
                        <option value="Aktif">Aktif</option>
                        <option value="Tidak Aktif">Tidak Aktif</option>
                        <option value="Pindah">Pindah</option>
                    </select>
                </td>
                <td><button type="button" class="btn btn-danger btn-sm remove-row">Hapus</button></td>
            `;
            tbody.appendChild(row);
        }
    
        function resetSiswaForm() {
            document.getElementById("siswaFormBody").innerHTML = `
                <tr>
                    <td><input type="text" name="nama_siswa[]" class="form-control" required></td>
                    <td><input type="text" name="nisn[]" class="form-control" placeholder="Opsional"></td>
                    <td>
                        <select name="jenis_kelamin[]" class="form-select" required>
                            <option value="">-- Pilih --</option>
                            <option value="L">Laki-laki</option>
                            <option value="P">Perempuan</option>
                        </select>
                    </td>
                    <td>
                        <select name="status[]" class="form-select">
                            <option value="Aktif">Aktif</option>
                            <option value="Tidak Aktif">Tidak Aktif</option>
                            <option value="Pindah">Pindah</option>
                        </select>
                    </td>
                    <td><button type="button" class="btn btn-danger btn-sm remove-row">Hapus</button></td>
                </tr>
            `;
        }
    
        function openEditModal(siswa) {
            document.getElementById("editId").value = siswa.id;
            document.getElementById("editNama").value = siswa.nama_siswa;
            document.getElementById("editNisn").value = siswa.nisn || '';
            document.getElementById("editJK").value = siswa.jenis_kelamin;
            document.getElementById("editStatus").value = siswa.status;
    
            const modal = new bootstrap.Modal(document.getElementById("editSiswaModal"));
            modal.show();
        }
    
        async function handleEditSiswa(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const id = formData.get("id");
    
            try {
                const resp = await fetch(`/siswa/update/${id}`, {
                    method: "POST",
                    body: formData
                });
                const result = await resp.json();
    
                if (result.success) {
                    alert("Data siswa berhasil diupdate");
                    const modalEl = document.getElementById("editSiswaModal");
                    bootstrap.Modal.getInstance(modalEl).hide();
    
                    // Update baris langsung di tabel
                    const row = document.querySelector(`#siswaTable tr[data-id="${id}"]`);
                    if (row) {
                        row.children[0].textContent = result.siswa.nama_siswa;
                        row.children[1].textContent = result.siswa.nisn || '-';
                        row.children[2].textContent = result.siswa.jenis_kelamin === "L" ? "Laki-laki" : "Perempuan";
                        row.children[3].textContent = result.siswa.status;
                    }
                } else {
                    alert(result.message);
                }
            } catch (error) {
                console.error('Error updating siswa:', error);
                alert("Terjadi kesalahan saat mengupdate siswa");
            }
        }
    
        // Handler Penilaian Kebiasaan
        function initializePenilaianKebiasaan() {
            kelasSelectPenilaian.addEventListener("change", () => 
                loadSiswaPenilaian(kelasSelectPenilaian.value));
            
            bulanSelectPenilaian.addEventListener("change", () => {
                updateMaxValuesPenilaian();
                if (kelasSelectPenilaian.value && bulanSelectPenilaian.value) {
                    loadNilaiPenilaian(kelasSelectPenilaian.value, bulanSelectPenilaian.value);
                }
            });
    
            if (siswaTableBodyPenilaian) {
                siswaTableBodyPenilaian.addEventListener("click", handlePenilaianActions);
            }
            
            document.addEventListener("input", (e) => {
                if (e.target.classList.contains("nilai-input") && e.target.type === "number") {
                    validateNilaiInput(e.target);
                }
            });
        }
    
        async function loadSiswaPenilaian(kelasId) {
            if (!siswaTableBodyPenilaian) return;
            
            siswaTableBodyPenilaian.innerHTML = "";
            if (!kelasId) {
                siswaTableBodyPenilaian.innerHTML = `<tr><td colspan="11" class="text-center">Silakan pilih kelas terlebih dahulu</td></tr>`;
                return;
            }
            
            try {
                const res = await fetch(`/penilaian/siswa/list/${kelasId}`);
                const siswaList = await res.json();
                
                if (!siswaList || !siswaList.length) {
                    siswaTableBodyPenilaian.innerHTML = `<tr><td colspan="11" class="text-center">Belum ada siswa di kelas ini</td></tr>`;
                    return;
                }
    
                siswaList.forEach((siswa, idx) => {
                    const row = document.createElement("tr");
                    row.dataset.siswaId = siswa.id;
                    row.dataset.kelasId = kelasId;
                    row.innerHTML = `
                        <td class="text-center">${idx+1}</td>
                        <td>${siswa.nama_siswa}
                            <input type="hidden" name="siswa_id" value="${siswa.id}">
                            <input type="hidden" name="kelas_id" value="${kelasId}">
                        </td>
                        <td><input type="number" class="form-control nilai-input" min="0" name="bangun_pagi" placeholder="0-31"></td>
                        <td><input type="number" class="form-control nilai-input" min="0" name="beribadah" placeholder="0-31"></td>
                        <td><input type="number" class="form-control nilai-input" min="0" name="berolahraga" placeholder="0-31"></td>
                        <td><input type="number" class="form-control nilai-input" min="0" name="sehat_dan_lemar" placeholder="0-31"></td>
                        <td><input type="number" class="form-control nilai-input" min="0" name="belajar" placeholder="0-31"></td>
                        <td><input type="number" class="form-control nilai-input" min="0" name="bermasyarakat" placeholder="0-31"></td>
                        <td><input type="number" class="form-control nilai-input" min="0" name="tidur_cepat" placeholder="0-31"></td>
                        <td><input type="text" class="form-control" name="catatan" placeholder="Catatan..."></td>
                        <td>
                            <div class="d-flex gap-1">
                                <button type="button" class="btn btn-primary btn-sm btn-save">Simpan</button>
                                <button type="button" class="btn btn-warning btn-sm btn-update" style="display:none;">Update</button>
                                <button type="button" class="btn btn-danger btn-sm btn-delete">Hapus Isi</button>
                            </div>
                        </td>
                    `;
                    if (siswaTableBodyPenilaian) {
                        siswaTableBodyPenilaian.appendChild(row);
                    }
                });
    
                updateMaxValuesPenilaian();
    
                if (bulanSelectPenilaian.value) {
                    loadNilaiPenilaian(kelasId, bulanSelectPenilaian.value);
                }
    
            } catch (err) {
                console.error(err);
                if (siswaTableBodyPenilaian) {
                    siswaTableBodyPenilaian.innerHTML = `<tr><td colspan="11" class="text-center text-danger">Gagal memuat data siswa</td></tr>`;
                }
            }
        }
    
        function updateMaxValuesPenilaian() {
            const bulanTahun = bulanSelectPenilaian?.value;
            if (!bulanTahun) return;
            
            const maxHari = getDaysInMonth(bulanTahun);
            const inputs = document.querySelectorAll('.nilai-input[type="number"]');
            
            inputs.forEach(input => {
                input.max = maxHari;
                input.title = `Nilai maksimal: ${maxHari} (sesuai jumlah hari dalam bulan)`;
            });
        }
    
        function getDaysInMonth(bulanTahun) {
            const [tahun, bulan] = bulanTahun.split('-').map(Number);
            return new Date(tahun, bulan, 0).getDate();
        }
    
        async function loadNilaiPenilaian(kelasId, bulan) {
            try {
                const res = await fetch(`/penilaian/kebiasaan/get/${kelasId}/${bulan}`);
                const data = await res.json();
    
                if (siswaTableBodyPenilaian) {
                    siswaTableBodyPenilaian.querySelectorAll("tr").forEach(tr => {
                        tr.querySelectorAll("input").forEach(i => {
                            if (!["siswa_id","kelas_id"].includes(i.name)) i.value = "";
                            i.removeAttribute("readonly");
                        });
                        const saveBtn = tr.querySelector(".btn-save");
                        const updateBtn = tr.querySelector(".btn-update");
                        if (saveBtn) saveBtn.style.display = "inline-block";
                        if (updateBtn) updateBtn.style.display = "none";
                    });
    
                    data.forEach(row => {
                        const tr = siswaTableBodyPenilaian.querySelector(`tr[data-siswa-id="${row.siswa_id}"]`);
                        if (!tr) return;
    
                        tr.querySelector('[name="bangun_pagi"]').value = row.bangun_pagi || "";
                        tr.querySelector('[name="beribadah"]').value = row.beribadah || "";
                        tr.querySelector('[name="berolahraga"]').value = row.berolahraga || "";
                        tr.querySelector('[name="sehat_dan_lemar"]').value = row.sehat_dan_lemar || "";
                        tr.querySelector('[name="belajar"]').value = row.belajar || "";
                        tr.querySelector('[name="bermasyarakat"]').value = row.bermasyarakat || "";
                        tr.querySelector('[name="tidur_cepat"]').value = row.tidur_cepat || "";
                        tr.querySelector('[name="catatan"]').value = row.catatan || "";
    
                        const hasData = row.bangun_pagi || row.beribadah || row.berolahraga ||
                                        row.sehat_dan_lemar || row.belajar || 
                                        row.bermasyarakat || row.tidur_cepat || row.catatan;
    
                        if (hasData) {
                            tr.querySelectorAll("input").forEach(i => i.setAttribute("readonly", true));
                            const saveBtn = tr.querySelector(".btn-save");
                            const updateBtn = tr.querySelector(".btn-update");
                            if (saveBtn) saveBtn.style.display = "none";
                            if (updateBtn) updateBtn.style.display = "inline-block";
                        } else {
                            const saveBtn = tr.querySelector(".btn-save");
                            const updateBtn = tr.querySelector(".btn-update");
                            if (saveBtn) saveBtn.style.display = "inline-block";
                            if (updateBtn) updateBtn.style.display = "none";
                        }
                    });
                }
            } catch (err) {
                console.error("Gagal load nilai:", err);
            }
        }
    
        async function handlePenilaianActions(e) {
            const row = e.target.closest("tr");
            if (!row) return;
            
            const siswaId = row.dataset.siswaId;
            const kelasId = row.dataset.kelasId;
            const bulan = bulanSelectPenilaian?.value;
            
            if (!bulan) { 
                alert("Pilih bulan terlebih dahulu"); 
                return; 
            }
    
            // Validasi nilai sebelum simpan
            const maxHari = getDaysInMonth(bulan);
            const inputs = row.querySelectorAll('.nilai-input[type="number"]');
            let valid = true;
            
            inputs.forEach(input => {
                const value = parseInt(input.value) || 0;
                if (value > maxHari) {
                    alert(`Nilai ${input.name} tidak boleh lebih dari ${maxHari} (jumlah hari dalam bulan)`);
                    input.focus();
                    valid = false;
                }
            });
            
            if (!valid) return;
    
            // SAVE / UPDATE
            if (e.target.classList.contains("btn-save") || e.target.classList.contains("btn-update")) {
                const formData = new FormData();
                formData.append("siswa_id", siswaId);
                formData.append("kelas_id", kelasId);
                formData.append("bulan", bulan);
                row.querySelectorAll("input").forEach(i => {
                    if (!["siswa_id","kelas_id"].includes(i.name)) {
                        formData.append(i.name, i.value || "");
                    }
                });
    
                try {
                    const res = await fetch("/penilaian/kebiasaan/save_row", {method:"POST", body:formData});
                    const result = await res.json();
                    alert(result.message);
                    if (result.success) {
                        row.querySelectorAll("input").forEach(i => i.setAttribute("readonly", true));
                        const saveBtn = row.querySelector(".btn-save");
                        const updateBtn = row.querySelector(".btn-update");
                        if (saveBtn) saveBtn.style.display = "none";
                        if (updateBtn) updateBtn.style.display = "inline-block";
                    }
                } catch(err){ 
                    console.error(err); 
                    alert("Terjadi kesalahan saat menyimpan"); 
                }
            }
    
            // DELETE
            if (e.target.classList.contains("btn-delete")) {
                if (!confirm("Hapus semua nilai kebiasaan siswa ini?")) return;
                try {
                    const res = await fetch(`/penilaian/kebiasaan/delete_row/${siswaId}/${bulan}`, {method:"POST"});
                    const result = await res.json();
                    alert(result.message);
                    if (result.success) {
                        row.querySelectorAll("input").forEach(i => { 
                            if(!["siswa_id","kelas_id"].includes(i.name)) i.value=""; 
                        });
                        row.querySelectorAll("input").forEach(i => i.removeAttribute("readonly"));
                        const saveBtn = row.querySelector(".btn-save");
                        const updateBtn = row.querySelector(".btn-update");
                        if (saveBtn) saveBtn.style.display = "inline-block";
                        if (updateBtn) updateBtn.style.display = "none";
                    }
                } catch(err){ 
                    console.error(err); 
                    alert("Terjadi kesalahan saat hapus data"); 
                }
            }
    
            // UNLOCK untuk UPDATE
            if (e.target.classList.contains("btn-update")) {
                row.querySelectorAll("input").forEach(i => i.removeAttribute("readonly"));
                const saveBtn = row.querySelector(".btn-save");
                const updateBtn = row.querySelector(".btn-update");
                if (saveBtn) saveBtn.style.display = "inline-block";
                if (updateBtn) updateBtn.style.display = "none";
            }
        }
    
        function validateNilaiInput(input) {
            const bulanTahun = bulanSelectPenilaian?.value;
            if (!bulanTahun) {
                alert("Pilih bulan terlebih dahulu");
                input.value = "";
                return;
            }
            
            const maxHari = getDaysInMonth(bulanTahun);
            let val = parseInt(input.value);
            
            if (isNaN(val)) {
                input.value = "";
                return;
            }
            
            if (val > maxHari) {
                input.value = maxHari;
                alert(`Nilai maksimal untuk bulan ini adalah ${maxHari} hari`);
            }
            
            if (val < 0) {
                input.value = 0;
            }
        }
    
        // Handler Change Password
        async function handleChangePassword(e) {
            e.preventDefault();
            const form = e.target;
            const msgDiv = document.getElementById("changePasswordMessage");
            msgDiv.textContent = "";
    
            const current_password = document.getElementById("currentPassword").value;
            const new_password = document.getElementById("newPassword").value;
            const confirm_password = document.getElementById("confirmPassword").value;
    
            if (new_password !== confirm_password) {
                msgDiv.textContent = "Password baru dan konfirmasi tidak cocok!";
                return;
            }
    
            try {
                const res = await fetch("{{ url_for('change_password') }}", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ current_password, new_password })
                });
                const result = await res.json();
    
                if (result.success) {
                    alert(result.message || "Password berhasil diubah!");
                    const modal = bootstrap.Modal.getInstance(document.getElementById("changePasswordModal"));
                    modal.hide();
                    form.reset();
                } else {
                    msgDiv.textContent = result.message || "Terjadi kesalahan!";
                }
            } catch (err) {
                console.error(err);
                msgDiv.textContent = "Terjadi kesalahan saat mengubah password!";
            }
        }
    
    // Handler Laporan
    function initializeLaporanModals() {
    // Laporan Bulanan
    document.getElementById("laporanForm")?.addEventListener("submit", function (e) {
        const kelasId = document.getElementById("kelasSelect").value;
        const bulan = document.getElementById("bulanSelect").value;

        if (!kelasId || !bulan) {
            alert("Tolong pilih kelas dan bulan terlebih dahulu.");
            e.preventDefault();
            return;
        }

        this.action = `/laporan/rchk/${kelasId}/${bulan}`;
    });

    // Laporan Semester
    document.getElementById("laporanSemesterForm")?.addEventListener("submit", function (e) {
        const kelasId = document.getElementById("kelasSemesterSelect").value;
        const semester = document.getElementById("semesterSelect").value;

        if (!kelasId || !semester) {
            alert("Tolong pilih kelas dan semester terlebih dahulu.");
            e.preventDefault();
            return;
        }

        this.action = `/laporan/semester/${kelasId}/${semester}`;
    });

    // Laporan Tahunan
    document.getElementById("laporanTahunanForm")?.addEventListener("submit", function (e) {
        const kelasId = document.getElementById("kelasTahunanSelect").value;

        if (!kelasId) {
            alert("Tolong pilih kelas terlebih dahulu.");
            e.preventDefault();
            return;
        }

        this.action = `/laporan/tahunan/${kelasId}`;
    });

    // ========== LAPORAN PENILAIAN SISWA - VERSI SEDERHANA ==========
    initSimpleLaporanPenilaianSiswa();
}

// VERSI SEDERHANA - Event delegation langsung
function initSimpleLaporanPenilaianSiswa() {
    const modal = document.getElementById('laporanPenilaianSiswaModal');
    if (!modal) {
        console.log("Modal laporan penilaian siswa tidak ditemukan");
        return;
    }

    // Event ketika modal dibuka
    modal.addEventListener('show.bs.modal', function() {
        console.log("=== MODAL LAPORAN DIBUKA ===");
        resetSimpleLaporanForm();
        loadSimpleTahunAjaran();
    });

    // Event delegation untuk semua perubahan
    modal.addEventListener('change', function(e) {
        const target = e.target;
        console.log("Perubahan di modal:", target.id, "value:", target.value);

        if (target.id === 'tahunAjaranSelect') {
            handleSimpleTahunAjaranChange(target.value);
        } else if (target.id === 'semesterSelect') {
            handleSimpleSemesterChange(target.value);
        } else if (target.id === 'kelasPenilaianSelect') {
            handleSimpleKelasChange(target.value);
        } else if (target.id === 'siswaPenilaianSelect') {
            handleSimpleSiswaChange();
        }
    });

    // Form submission
    document.getElementById("laporanPenilaianSiswaForm")?.addEventListener("submit", function (e) {
        const tahunAjaranId = document.getElementById("tahunAjaranSelect").value;
        const semester = document.getElementById("semesterSelect").value;
        const kelasId = document.getElementById("kelasPenilaianSelect").value;
        const siswaId = document.getElementById("siswaPenilaianSelect").value;

        console.log("Form submit:", { tahunAjaranId, semester, kelasId, siswaId });

        if (!tahunAjaranId || !semester || !kelasId || !siswaId) {
            alert("Harap pilih semua field terlebih dahulu!");
            e.preventDefault();
            return;
        }

        this.action = `/laporan/penilaian-siswa/${siswaId}?tahun_ajaran_id=${tahunAjaranId}&semester=${semester}`;
        console.log("Action URL:", this.action);
    });
}

// Fungsi sederhana load tahun ajaran
async function loadSimpleTahunAjaran() {
    console.log("üî∏ Memuat tahun ajaran...");
    const tahunAjaranSelect = document.getElementById("tahunAjaranSelect");
    if (!tahunAjaranSelect) {
        console.error("‚ùå tahunAjaranSelect tidak ditemukan");
        return;
    }

    try {
        const response = await fetch('/laporan/api/tahun-ajaran');
        console.log("üî∏ Response status:", response.status);
        
        const data = await response.json();
        console.log("üî∏ Data tahun ajaran:", data);
        
        tahunAjaranSelect.innerHTML = '<option value="">-- Pilih Tahun Ajaran --</option>';
        
        if (data.tahun_ajaran && data.tahun_ajaran.length > 0) {
            data.tahun_ajaran.forEach(ta => {
                const option = document.createElement("option");
                option.value = ta.id;
                option.textContent = `${ta.tahun_ajaran} (${ta.semester})`;
                tahunAjaranSelect.appendChild(option);
            });
            tahunAjaranSelect.disabled = false;
            console.log("‚úÖ Tahun ajaran berhasil dimuat");
        } else {
            tahunAjaranSelect.disabled = true;
            console.warn("‚ö†Ô∏è Tidak ada tahun ajaran tersedia");
        }
    } catch (error) {
        console.error("‚ùå Error loading tahun ajaran:", error);
        tahunAjaranSelect.disabled = true;
    }
}

// Handler sederhana untuk tahun ajaran
function handleSimpleTahunAjaranChange(tahunAjaranId) {
    console.log("üî∏ Tahun ajaran berubah:", tahunAjaranId);
    const semesterSelect = document.getElementById("semesterSelect");
    
    if (semesterSelect) {
        semesterSelect.disabled = !tahunAjaranId;
        if (!tahunAjaranId) {
            resetSimpleKelasAndSiswa();
        }
        console.log("üî∏ Semester select disabled:", semesterSelect.disabled);
    }
}

// Handler sederhana untuk semester
function handleSimpleSemesterChange(semester) {
    console.log("üî∏ Semester berubah:", semester);
    const tahunAjaranSelect = document.getElementById("tahunAjaranSelect");
    
    if (tahunAjaranSelect && tahunAjaranSelect.value && semester) {
        console.log("üî∏ Memuat kelas untuk tahun ajaran:", tahunAjaranSelect.value);
        loadSimpleKelasByTahunAjaran(tahunAjaranSelect.value);
    } else {
        resetSimpleKelasAndSiswa();
    }
}

// Fungsi sederhana load kelas
async function loadSimpleKelasByTahunAjaran(tahunAjaranId) {
    console.log("üî∏ Memuat kelas untuk tahun ajaran:", tahunAjaranId);
    const kelasSelect = document.getElementById("kelasPenilaianSelect");
    if (!kelasSelect) {
        console.error("‚ùå kelasPenilaianSelect tidak ditemukan");
        return;
    }

    try {
        const response = await fetch(`/laporan/api/kelas-by-tahun-ajaran/${tahunAjaranId}`);
        console.log("üî∏ Response status kelas:", response.status);
        
        const data = await response.json();
        console.log("üî∏ Data kelas:", data);
        
        kelasSelect.innerHTML = '<option value="">-- Pilih Kelas --</option>';
        
        if (data.kelas && data.kelas.length > 0) {
            data.kelas.forEach(kelas => {
                const option = document.createElement("option");
                option.value = kelas.id;
                option.textContent = kelas.nama_kelas;
                kelasSelect.appendChild(option);
            });
            kelasSelect.disabled = false;
            console.log("‚úÖ Kelas berhasil dimuat:", data.kelas.length, "kelas");
        } else {
            kelasSelect.disabled = true;
            kelasSelect.innerHTML = '<option value="">-- Tidak ada kelas --</option>';
            console.warn("‚ö†Ô∏è Tidak ada kelas untuk tahun ajaran ini");
        }
    } catch (error) {
        console.error("‚ùå Error loading kelas:", error);
        kelasSelect.disabled = true;
    }
}

// Handler sederhana untuk kelas
function handleSimpleKelasChange(kelasId) {
    console.log("üî∏ Kelas berubah:", kelasId);
    const siswaSelect = document.getElementById("siswaPenilaianSelect");
    
    if (kelasId && siswaSelect) {
        console.log("üî∏ Memuat siswa untuk kelas:", kelasId);
        loadSiswaForLaporan(kelasId, siswaSelect);
    } else {
        resetSimpleSiswa();
    }
}

// Handler sederhana untuk siswa
function handleSimpleSiswaChange() {
    console.log("üî∏ Siswa berubah");
    checkSimpleFormCompleteness();
}

// Reset functions sederhana
function resetSimpleLaporanForm() {
    console.log("üî∏ Reset form laporan");
    const tahunAjaranSelect = document.getElementById("tahunAjaranSelect");
    const semesterSelect = document.getElementById("semesterSelect");
    
    if (tahunAjaranSelect) {
        tahunAjaranSelect.innerHTML = '<option value="">-- Pilih Tahun Ajaran --</option>';
        tahunAjaranSelect.disabled = false;
    }
    
    if (semesterSelect) {
        semesterSelect.innerHTML = '<option value="">-- Pilih Semester --</option>';
        semesterSelect.disabled = true;
    }
    
    resetSimpleKelasAndSiswa();
}

function resetSimpleKelasAndSiswa() {
    console.log("üî∏ Reset kelas dan siswa");
    const kelasSelect = document.getElementById("kelasPenilaianSelect");
    if (kelasSelect) {
        kelasSelect.innerHTML = '<option value="">-- Pilih Kelas --</option>';
        kelasSelect.disabled = true;
    }
    resetSimpleSiswa();
}

function resetSimpleSiswa() {
    console.log("üî∏ Reset siswa");
    const siswaSelect = document.getElementById("siswaPenilaianSelect");
    if (siswaSelect) {
        siswaSelect.innerHTML = '<option value="">-- Pilih Siswa --</option>';
        siswaSelect.disabled = true;
    }
    checkSimpleFormCompleteness();
}

function checkSimpleFormCompleteness() {
    const tahunAjaranSelect = document.getElementById("tahunAjaranSelect");
    const semesterSelect = document.getElementById("semesterSelect");
    const kelasSelect = document.getElementById("kelasPenilaianSelect");
    const siswaSelect = document.getElementById("siswaPenilaianSelect");
    const submitBtn = document.getElementById("submitLaporanBtn");
    
    if (!submitBtn) return;
    
    const semuaTerisi = tahunAjaranSelect?.value && 
                       semesterSelect?.value && 
                       kelasSelect?.value && 
                       siswaSelect?.value;
    
    submitBtn.disabled = !semuaTerisi;
    console.log("üî∏ Submit button disabled:", !semuaTerisi);
}
        // Fungsi load siswa untuk laporan
        async function loadSiswaForLaporan(kelasId, siswaSelect) {
            if (!siswaSelect) return;
            
            siswaSelect.innerHTML = '<option value="">-- Pilih Siswa --</option>';
            
            if (!kelasId) {
                siswaSelect.disabled = true;
                return;
            }
    
            try {
                const response = await fetch(`/siswa/list/${kelasId}`);
                const data = await response.json();
                
                if (data.success && data.siswa) {
                    data.siswa.forEach(siswa => {
                        const option = document.createElement("option");
                        option.value = siswa.id;
                        option.textContent = siswa.nama_siswa;
                        siswaSelect.appendChild(option);
                    });
                    siswaSelect.disabled = false;
                } else {
                    siswaSelect.disabled = true;
                }
            } catch (error) {
                console.error("Error loading siswa:", error);
                siswaSelect.disabled = true;
            }
        }
    
        // Fungsi untuk mencari siswa yang sudah ada
        window.searchExistingSiswa = async function() {
            const searchTerm = document.getElementById('searchSiswa').value.trim();
            const kelasId = document.getElementById('kelasDropdown').value;
            
            if (!searchTerm) {
                alert('Masukkan nama atau NISN siswa untuk dicari');
                return;
            }
    
            if (!kelasId) {
                alert('Pilih kelas terlebih dahulu');
                return;
            }
    
            try {
                const response = await fetch(`/siswa/search?q=${encodeURIComponent(searchTerm)}&kelas_id=${kelasId}`);
                const data = await response.json();
                
                displaySearchResults(data.siswa);
            } catch (error) {
                console.error('Error searching siswa:', error);
                alert('Gagal mencari siswa');
            }
        };
    
        // Fungsi untuk menampilkan hasil pencarian
        function displaySearchResults(siswaList) {
            const resultsContainer = document.getElementById('searchResults');
            
            if (!siswaList || siswaList.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="alert alert-warning">
                        Tidak ditemukan siswa dengan kata kunci tersebut.
                    </div>
                `;
                return;
            }
    
            let html = `
                <div class="list-group">
                    <div class="list-group-item bg-light">
                        <strong>Hasil Pencarian (${siswaList.length} siswa ditemukan):</strong>
                    </div>
            `;
    
            siswaList.forEach(siswa => {
                const isInCurrentClass = siswa.kelas_id && siswa.kelas_id.toString() === document.getElementById('kelasDropdown').value;
                
                html += `
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${siswa.nama_siswa}</strong>
                            ${siswa.nisn ? `<br><small class="text-muted">NISN: ${siswa.nisn}</small>` : ''}
                            ${siswa.kelas ? `<br><small class="text-muted">Kelas: ${siswa.kelas.nama_kelas}</small>` : ''}
                            ${siswa.sekolah ? `<br><small class="text-muted">Sekolah: ${siswa.sekolah.nama_sekolah}</small>` : ''}
                        </div>
                        <div>
                            ${isInCurrentClass ? 
                                '<span class="badge bg-success me-2">Sudah di kelas ini</span>' : 
                                `<button type="button" class="btn btn-primary btn-sm" onclick="addExistingSiswa(${siswa.id})">
                                    Tambah ke Kelas
                                </button>`
                            }
                        </div>
                    </div>
                `;
            });
    
            html += `</div>`;
            resultsContainer.innerHTML = html;
        }
    
        // Fungsi untuk menambahkan siswa yang sudah ada ke kelas
        window.addExistingSiswa = async function(siswaId) {
            const kelasId = document.getElementById('kelasDropdown').value;
            
            if (!confirm('Tambahkan siswa ini ke kelas?')) return;
    
            try {
                const response = await fetch('/siswa/add_to_class', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        siswa_id: siswaId,
                        kelas_id: kelasId
                    })
                });
    
                const result = await response.json();
                
                if (result.success) {
                    alert('Siswa berhasil ditambahkan ke kelas!');
                    // Refresh daftar siswa
                    await loadSiswa(kelasId);
                    // Clear search results
                    document.getElementById('searchResults').innerHTML = '';
                    document.getElementById('searchSiswa').value = '';
                } else {
                    alert('Gagal menambahkan siswa: ' + result.message);
                }
            } catch (error) {
                console.error('Error adding siswa:', error);
                alert('Terjadi kesalahan saat menambahkan siswa');
            }
        };
    });
// ‚úÖ FUNCTION GLOBAL UNTUK GENERATE REPORT
    function generateReport() {
    const kelasId = document.getElementById('kelasSelectPenilaian')?.value;
    const bulan = document.getElementById('bulanSelectPenilaian')?.value;
    
    if (!kelasId || !bulan) {
        alert("Harap pilih kelas dan bulan terlebih dahulu!");
        return;
    }
    
    window.open(`/laporan/rchk/${kelasId}/${bulan}`, '_blank');
}
    </script>
</body>
</html>